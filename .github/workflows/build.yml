name: Build ExtremeROM

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: "Build type"
        required: true
        default: "release"
        type: choice
        options:
          - release
          - debug

jobs:
  build:
    runs-on: ubuntu-24.04
    permissions:
      contents: write

    strategy:
      fail-fast: false
      matrix:
        target: [x1s, y2s, z3s, c1s, c2s, r8s]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6
        with:
          submodules: 'recursive'

      - name: Free disk space (1/3)
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          sudo docker builder prune -a

      - name: Free disk space (2/3)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true

      - name: Free disk space (3/3)
        uses: rokibhasansagar/slimhub_actions@main
        with:
          retain: 'compiler_cmake'

      - name: Set up build environment
        run: |
          sudo apt update
          DEBIAN_FRONTEND=noninteractive sudo apt install -yq \
            p7zip-full jq attr ccache clang ffmpeg golang \
            libbrotli-dev libgtest-dev libprotobuf-dev libunwind-dev libpcre2-dev \
            libzstd-dev linux-modules-extra-$(uname -r) lld protobuf-compiler webp \
            curl xxd patchelf flex bison libarchive-tools build-essential pcre2-utils
          sudo modprobe erofs f2fs
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          echo -n "${{ secrets.PLATFORM_KEY_PK8 }}" | base64 --decode > security/extremerom_platform.pk8
          echo -n "${{ secrets.PLATFORM_KEY_PEM }}" | base64 --decode > security/extremerom_platform.x509.pem

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: Build dependencies
        run: |
          source ./buildenv.sh ${{ matrix.target }}
          ./scripts/build_dependencies.sh

      - name: Download source firmware
        run: |
          source ./buildenv.sh ${{ matrix.target }}
          ./scripts/download_fw.sh --force --ignore-target

      - name: Extract source firmware
        run: |
          source ./buildenv.sh ${{ matrix.target }}
          ./scripts/extract_fw.sh --force --ignore-target

      - name: Download target firmware
        run: |
          source ./buildenv.sh ${{ matrix.target }}
          ./scripts/download_fw.sh --force --ignore-source

      - name: Extract target firmware
        run: |
          source ./buildenv.sh ${{ matrix.target }}
          ./scripts/extract_fw.sh --force --ignore-source

      - name: Add swapspace
        uses: thejerrybao/setup-swap-space@v1
        with:
           swap-space-path: /swapfile
           swap-size-gb: 12
           remove-existing-swap-files: true

      - name: Build ROM
        run: |
          source ./buildenv.sh ${{ matrix.target }}
          ./scripts/make_rom.sh --force

      - name: Upload build to Pixeldrain and Handle XML
        env:
          PIXELDRAIN_API_KEY: ${{ secrets.PD_API }}
          BUILD_TYPE: ${{ github.event.inputs.build_type }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Uploading ROM files to Pixeldrain..."

          for file in out/*.zip; do
            if [ -f "$file" ]; then
              FILE_NAME=$(basename "$file")
              FILE_SIZE=$(stat -c%s "$file")
              FILE_MD5=$(md5sum "$file" | awk '{print $1}')
              VERSION=$(echo "$FILE_NAME" | grep -oP '\d+\.\d+\.\d+')
              BUILD_DATE=$(date +%Y-%m-%d)

              RESPONSE=$(curl -s -T "$file" -u :$PIXELDRAIN_API_KEY https://pixeldrain.com/api/file/)
              FILE_ID=$(echo $RESPONSE | jq -r '.id')
              DOWNLOAD_URL="https://pixeldrain.com/api/file/$FILE_ID?download"

              echo ""
              echo "File: $FILE_NAME"
              echo "Size (bytes): $FILE_SIZE"
              echo "MD5: $FILE_MD5"
              echo "Download: $DOWNLOAD_URL"
              echo ""

              if [ "$BUILD_TYPE" = "release" ]; then
                echo "Release build detected — updating XML..."

                git clone https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }} updater_repo
                cd updater_repo
                git checkout main

                mkdir -p updater
                XML_FILE="updater/${{ matrix.target }}.xml"

                echo '<?xml version="1.0" encoding="UTF-8"?>' > $XML_FILE
                echo '<roms>' >> $XML_FILE
                echo '    <rom channel="stable">' >> $XML_FILE
                echo "        <version>$VERSION</version>" >> $XML_FILE
                echo "        <date>$BUILD_DATE</date>" >> $XML_FILE
                echo "        <filename>$FILE_NAME</filename>" >> $XML_FILE
                echo "        <url>$DOWNLOAD_URL</url>" >> $XML_FILE
                echo "        <md5>$FILE_MD5</md5>" >> $XML_FILE
                echo "        <size>$FILE_SIZE</size>" >> $XML_FILE
                echo '    </rom>' >> $XML_FILE
                echo '</roms>' >> $XML_FILE

                git config user.name "github-actions[bot]"
                git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

                git add $XML_FILE
                git commit -m "Update ${{ matrix.target }} to $VERSION" || echo "No changes to commit"
                git pull --rebase origin main
                git push origin main

                cd ..
              else
                echo "Debug build selected — skipping XML generation."
              fi
            else
              echo "No ZIP files found to upload."
            fi
          done
